CREATE OR REPLACE VIEW BCTS_STAGING.SILVILIABILITY_RESULTS AS
WITH ML AS
(
    SELECT
    SM.STOCKING_STANDARD_UNIT_ID,
    MAX(SM.DECLARED_DATE) AS DECLARED_DATE
    FROM
    RESULTS_REPLICATION.STOCKING_MILESTONE SM
    WHERE
    SM.SILV_MILESTONE_TYPE_CODE = 'FG'
    AND SM.DECLARE_IND = 'Y'
    GROUP BY
    SM.STOCKING_STANDARD_UNIT_ID
    ORDER BY
        1
),
FG AS
    (
    SELECT
        SU.OPENING_ID,
        COUNT(DISTINCT SU.STOCKING_STANDARD_UNIT_ID) AS SU_COUNT,
        COUNT(DISTINCT ML.STOCKING_STANDARD_UNIT_ID) AS SU_FG_COUNT,
        MAX(ML.DECLARED_DATE) AS DECLARED_DATE

    FROM
        RESULTS_REPLICATION.STOCKING_STANDARD_UNIT SU
        LEFT JOIN ML
        ON SU.STOCKING_STANDARD_UNIT_ID = ML.STOCKING_STANDARD_UNIT_ID 
    GROUP BY
        SU.OPENING_ID

    HAVING
        COUNT(DISTINCT SU.STOCKING_STANDARD_UNIT_ID) = COUNT(DISTINCT ML.STOCKING_STANDARD_UNIT_ID)

    ORDER BY 1
    ) 

SELECT
    CB.FOREST_FILE_ID,
    CB.CUT_BLOCK_ID,
    MAX(CB.OPENING_ID) AS OPENING,
    COUNT(CB.OPENING_ID) AS OPENING_COUNT,
    -- COUNT(FG.OPENING_ID) AS OPENING_FG_COUNT,
    MAX(FG.DECLARED_DATE) AS RESULTS_FG_DECLARED

FROM
    RESULTS_REPLICATION.RSLT_OPENING_POLYGON CB
    LEFT JOIN FG
ON
    CB.OPENING_ID = FG.OPENING_ID 

GROUP BY
    CB.FOREST_FILE_ID, CB.CUT_BLOCK_ID

HAVING
    COUNT(DISTINCT CB.OPENING_ID) = COUNT(DISTINCT FG.OPENING_ID)

ORDER BY
    1,
    2
;
